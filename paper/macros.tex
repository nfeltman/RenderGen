\newcommand {\TODO} {\textbf{TODO:} }

\usepackage{color}
\definecolor{needsfixcolor}{rgb}{0.8,0.0,0.0}
\newcommand{\needsfix}[1]{{\color{needsfixcolor}\textbf{#1}}}

% core conventions and language names
\newcommand {\bbone} {\ensuremath{ 1}}
\newcommand {\bbtwo} {\ensuremath{ 2}}
\newcommand {\bbmono} {\ensuremath{ M}}
\newcommand {\ellStaged} {$\mathrm{L}^{\bbone\bbtwo}$}
\newcommand {\ellResid} {$\mathrm{L^R}$}
\newcommand {\ellTarget} {$\mathrm{L^T}$}
\newcommand {\lamStaged} {$\lambda^{\bbone\bbtwo}$}
\newcommand {\lamCircle} {$\lambda^{\fut}$}
\newcommand {\lamResid} {$\mathrm{\lambda^R}$}
\newcommand {\lamTarget} {$\mathrm{\lambda^T}$}
\newcommand {\lang} {\lamStaged}
\newcommand {\langTwo} {$\lambda^\bbtwo$}
\newcommand {\langmono} {$\lambda$}
\newcommand {\rmint} {{\rm int}}
\newcommand {\rmunit} {{\rm unit}}
\newcommand {\rmbool} {{\rm bool}}

% metatheory
\newcommand{\wfsym}{\ensuremath{\mathsf{wf}}}
\newcommand{\pvalsym}{\ensuremath{\mathsf{pval}}}
\newcommand{\ressym}{\ensuremath{\mathsf{res}}}
\newcommand{\valsym}{\ensuremath{\mathsf{val}}}
\newcommand{\fconsym}{\ensuremath{\mathsf{fcon}}}
\newcommand{\wf}{\ \wfsym}
\newcommand{\pval}{\ \pvalsym}
\newcommand{\res}{\ \ressym}
\newcommand{\val}{\ \valsym}
\newcommand{\fcon}{\ \fconsym}

% bnf stuff
\newcommand {\myit} [1]{\operatorname{\it{#1}}}
\newcommand {\stage} {\langle\mathit{stage}\rangle}
\newcommand {\type} {\tau}
\newcommand {\typeo} {\langle\bbone\text{-}\mathit{type}\rangle}
\newcommand {\typet} {\langle\bbtwo\text{-}\mathit{type}\rangle}
\newcommand {\expr} {e}
\newcommand {\brancho} {\langle\bbone\text{-}\mathit{brn}\rangle}
\newcommand {\brancht} {\langle\bbtwo\text{-}\mathit{brn}\rangle}
\newcommand {\expro} {\langle\bbone\text{-}\mathit{exp}\rangle}
\newcommand {\exprt} {\langle\bbtwo\text{-}\mathit{exp}\rangle}
%\newcommand {\val} {\langle\mathit{val}\rangle}
\newcommand {\valo} {\langle\bbone\text{-}\mathit{val}\rangle}
\newcommand {\valt} {\langle\bbtwo\text{-}\mathit{val}\rangle}
\newcommand {\world} {w}
\newcommand {\var} {x}
\newcommand {\emptyC} {\bullet}
\newcommand {\context} {\Gamma}
\newcommand {\inte} {i}
\newcommand {\bool} {b}
\newcommand {\resi} {\langle\mathit{res}\rangle}
\newcommand {\gbar} {~~|~~}

% nodes
\newcommand {\pause} {{\tt hold}}
\renewcommand {\next} {{\tt next}}
\newcommand {\prev} {{\tt prev}}
\newcommand {\monoSt} {{\tt mono}}
\newcommand {\fut} {\bigcirc}
\newcommand {\inl} {{\tt inl}}
\newcommand {\inr} {{\tt inr}}
\newcommand {\pio} {{\tt pi1}}
\newcommand {\pit} {{\tt pi2}}
\newcommand {\roll} {{\tt roll}}
\newcommand {\unroll} {{\tt unroll}}
\newcommand {\letin} [3] {{\tt let}~{#1} = {#2}~{\tt in}~{#3}}
\newcommand {\talllet} [3] {\begin{array}{l} {\tt let}~{#1} = {#2}~{\tt in} \\ {#3}\end{array}}
\newcommand {\caseof} [3] {{\tt case}~{#1} ~{\tt of}~{#2}~{\tt |}~{#3}}
\newcommand {\tallcase} [3] {\begin{array}{l} {\tt case}~{#1} ~{\tt of}\\~~{#2}\\{\tt |}~{#3} \end{array}}
\newcommand {\ifthen} [3] {{\tt if}~{#1} ~{\tt then}~{#2}~{\tt else}~{#3}}
\newcommand {\tallif} [3] {\begin{array}{l} {\tt if}~{#1} \\{\tt then}~{#2}\\{\tt else}~{#3} \end{array}}
\newcommand {\lam} [3] {\lambda{#1}\mathrm{:}{#2}.{#3}}
\newcommand {\valprod} [2] {({#1},{#2})}
\newcommand {\projbind} [1] {\letin{l_{#1}}{\pi_{#1} l}{r_{#1}}}

%judgments
\newcommand {\colone} [2] {{#1}:{#2}~@~\bbone}
\newcommand {\coltwo} [2] {{#1}:{#2}~@~\bbtwo}
\newcommand {\colmono} [2] {{#1}:{#2}~@~\bbmono}
\newcommand {\colwor} [2] {{#1}:{#2}~@~w}
\newcommand {\typesone} [3] [\Gamma] { {#1} \vdash \colone{#2}{#3}}
\newcommand {\typestwo} [3] [\Gamma] { {#1} \vdash \coltwo{#2}{#3}}
\newcommand {\typesmono} [3] [\Gamma] { {#1} \vdash \colmono{#2}{#3}}
\newcommand {\typeswor} [3] [] { \Gamma{#1} \vdash \colwor{#2}{#3}}
\newcommand {\types} [3] [\Gamma] {{#1} \vdash {#2}:{#3}}
\newcommand {\istypeone} {~{\rm type}~@~\bbone}
\newcommand {\istypetwo} {~{\rm type}~@~\bbtwo}
\newcommand {\istypewor} {~{\rm type}~@~w}

\newcommand {\typeslangTwo} [3] [\Gamma] {{#1} \vdash_\bbtwo {#2}:{#3}}

\newcommand {\reify} [3] {[{#1};{#2}]\overset{R}\Rightarrow{#3}}
\newcommand {\erasone} {\Downarrow^e_\bbone}
\newcommand {\erastwo} {\Downarrow^e_\bbtwo}
\newcommand {\isvalone} [1] {\Gamma \vdash {#1}~{\rm val}~@~\bbone}
\newcommand {\isvaltwo} {~{\rm val}~@~\bbtwo}
\newcommand {\isvalwor} {~{\rm val}~@~w}
%\newcommand {\reducexpl} [4] {{#3} \Downarrow_{#1}^{#2} {#4}}
%\newcommand {\redone} [2] {{#1} \Downarrow_\bbone^L {#2}}
%\newcommand {\redtwo} [2] {{#1} \Downarrow_\bbtwo^\bbtwo {#2}}
%\newcommand {\reducewor} [2] {{#1} \Downarrow_w^L {#2}}
\newcommand {\specwor} [2] [] {{#2} \downarrow_{#1}}
\newcommand {\diaone} [3] [\Gamma] {{#1} \vdash {#2} \Downarrow_\bbone [{#3}]}
\newcommand {\diatwo} [3] [\Gamma] {{#1} \vdash {#2} \Downarrow_\bbtwo {#3}}
\newcommand {\reduce} [2] {{#1} \Downarrow {#2}}
\newcommand {\reifysym} {\overset{R}\Rightarrow}
\newcommand {\redsym} {{\Downarrow}}
\newcommand {\redonesym} {{\Downarrow_\bbone}}
\newcommand {\redtwosym} {{\Downarrow_\bbtwo}}
\newcommand {\tworedsym} {{\downarrow_\bbtwo}}

%\newcommand {\reduceonesub} [1] [] {\reduceone{e_{#1}}{v_{#1}}}
%\newcommand {\reducetwosub} [1] [] {\reducetwo{e_{#1}}{v_{#1}}}
\newcommand {\reduceworsub} [1] [] {\reducewor{e_{#1}}{v_{#1}}}
\newcommand {\specworsub} [1] [] {\specwor{e_{#1}}}
\newcommand {\diaonesub} [1] [] {\diaone{e_{#1}}{\xi_{#1};v_{#1}}}
\newcommand {\diatwosub} [1] [] {\diatwo{e_{#1}}{q_{#1}}}

\newcommand {\vsplito} {\overset{\bbone}\curvearrowbotright}
\newcommand {\vsplits} {\overset{\bbtwo}\curvearrowbotright}
\newcommand {\tsplito} {\overset{\bbone}\curvearrowright}
\newcommand {\tsplits} {\overset{\bbtwo}\curvearrowright}
\newcommand {\csplit} {\curvearrowright}
\newcommand {\ssplit} {\curvearrowbotright}

\newcommand {\splitonesym} {\overset{\bbone}\rightsquigarrow}
\newcommand {\splittwosym} {\overset{\bbtwo}\rightsquigarrow}
\newcommand {\splitone} [4] [\Gamma] {{#2} \splitonesym \left[{#4}\right]}
\newcommand {\splittwo} [4] [\Gamma] {{#2} \splittwosym \left[{#4}\right]}
\newcommand {\splitonesub} [3] [\Gamma] {\splitone [{#1}] {e_{#2}}{#3}{c_{#2}, l_{#2}.r_{#2}}}
\newcommand {\splittwosub} [3] [\Gamma] {\splittwo [{#1}] {e_{#2}}{#3}{p_{#2}, l_{#2}.r_{#2}}}

%misc
\newcommand{\dom}[1]{\mathsf{dom}(#1)}
\newcommand {\gcomp} [2] {\xi_{#1}, \xi_{#2}}
\newcommand {\daviesz} {\overset 0 \hookrightarrow}
\newcommand {\davieso} {\overset 1 \hookrightarrow}

%default stuff
\newcommand \ty \typesone
\newcommand \red \reduce
\newcommand \sub \reduceonesub
\newcommand \spl \splitone
\newcommand \col \colone

%inference extension
\newcommand {\infertypeswor}  [3] 
		[NONAME]{
			\renewcommand \ty \typeswor
			\renewcommand \col \colwor
			\infer %[\mathrm{#1}] 
      {#2}{#3}}
\newcommand {\inferreducewor} [3] 
		[NONAME]{
			\renewcommand \red \reducewor
			\renewcommand \sub \reduceworsub
			\infer [\mathrm{#1\Downarrow}] 
      {#2}{#3}}
\newcommand {\inferreducespc} [3] 
		[NONAME]{
			\renewcommand \red \specwor
			\renewcommand \sub \specworsub
			\infer [\mathrm{#1\downarrow}] {#2}{#3}}
\newcommand {\inferdiaone} [3] 
		[NONAME]{
			\renewcommand \red \diaone
			\renewcommand \sub \diaonesub
			\infer %[\mathrm{#1\Downarrow_\bbone}] 
      {#2}{#3}}
\newcommand {\inferdiaspc} [3] 
		[NONAME]{
			\renewcommand \red \diatwo
			\renewcommand \sub \diatwosub
			\infer %[\mathrm{#1\Downarrow_\bbtwo}] 
      {#2}{#3}}
\newcommand {\infersplitone}  [3] 
		[NONAME]{
			\renewcommand \spl \splitone
			\renewcommand \sub \splitonesub
			\renewcommand \col \colone
			\infer %[\mathrm{#1 \overset{\bbone}\rightsquigarrow}]
      {#2}{#3}}
\newcommand {\infersplittwo}  [3] 
		[NONAME]{
			\renewcommand \spl \splittwo
			\renewcommand \sub \splittwosub
			\renewcommand \col \coltwo
			\infer %[\mathrm{#1 \overset{\bbtwo}\rightsquigarrow}]
      {#2}{#3}}
