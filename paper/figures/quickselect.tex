%!TEX root = ../paper.tex

\begin{figure*}[t]
\begin{subfigure}[t]{0.45\textwidth}
\begin{lstlisting} 

datatype list = Empty | Cons of int * list

fun partition (p, Empty) = (0,Empty, Empty) 
  | partition (p, Cons (h,t)) = 
    let val (s,left,right) = partition (p,t) 
    in if h < p then (s+1,Cons(h,left),right) 
             else (s,left,Cons(h,right))

qs: list * int -> int
fun qs (Empty, k) = 0
  | qs (Cons ht, k) =
    let val (i,left,right) = partition ht
    in case compare k i of
         LT => qs (left, k)
       | EQ => #1 ht
       | GT => qs (right, k-i-1)
       
\end{lstlisting}
\caption{Unstaged implementation of quickselect.}
\label{fig:qs-unstaged}
\end{subfigure}
\hfill
\begin{subfigure}[t]{0.55\textwidth}
\begin{lstlisting} 
3`atsigngr{`  
1`datatype list = Empty | Cons of int * list

fun partition (p, Empty) = ...  (* Same as in unstaged *)



3`}`

1`qss : ^list * $`2`int`1` -> $`2`int`1`
fun qss (`3`gr{`1`Empty`3`}`1`,_) = next {`2`0`1`}
  | qss (`3`gr{`1`Cons ht`3`}`1`,next{`2`k`1`}) = 
    let val `3`gr{`1`(i0,left,right)`3`}`1` = `3`gr{`1`partition ht`3`}`1`
        val next{`2`i`1`} = hold `3`gr{`1`i0`3`}`1`
    in next{`2` case compare k i of
               LT => prev {`1`qss (`3`gr{`1`left`3`}`1`, next{`2`k`1`})`2`}
             | EQ => prev {`1`hold `3`gr{`1`#1 ht`3`}`2`}
             | GT => prev {`1`qss (`3`gr{`1`right`3`}`1`, next{`2`k-i-literalone`1`})`2`}`1`}`
\end{lstlisting}
\caption{Staged implementation of quickselect in \lang.}

%\vspace{1.3em}
\label{fig:qs-staged}
\end{subfigure}
\caption{Quickselect: traditional and staged.}
\end{figure*}

