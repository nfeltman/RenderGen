%!TEX root = ../paper.tex

\begin{figure*}
\begin{subfigure}{0.5\textwidth}
\begin{lstlisting} 
datatype list = Empty | Cons of int * list

fun part (p, Empty) = (0,Empty, Empty) 
  | part (p, Cons (h,t)) = 
    let val (s,left,right) = part (p,t) in 
    if h<p 
    then (s+1,Cons(h,left),right) 
    else (s,left,Cons(h,right))

fun qSelect (Empty, k) = 0
  | qSelect (Cons ht, k) =
    let val (n,left,right) = part ht in
    case compare k n of
      LT => qSelect (left, k)
    | EQ => #1 ht
    | GT => qSelect (right, k-1-n)
\end{lstlisting}
\caption{Unstaged implementation of quickselect.}
\label{fig:qs-unstaged}
\end{subfigure}
% \begin{subfigure}{0.5\textwidth}
% \begin{lstlisting} 
% 1`atsigngrnd{
%   datatype list = Empty | Cons of int * list
%   fun part (...) = ...
% } 
% `//1`qsStaged : ^list * $`2`int`1` -> $`2`int`1`
% fun qsStaged (Empty,_) = next {`2`0`1`}
%   | qsStaged (Cons ht,next{`2`k`1`}) = 
%     let 
%       val (n0,l,r) = part ht
%       val next{`2`n`1`} = hold n0 
%     in next{`2`
%       case compare k n of
%         LT => prev {`1`qsStaged (l, next{`2`k`1`})`2`}
%       | EQ => prev {`1`hold (#1 ht)`2`}
%       | GT => prev {`1`qsStaged (r, next{`2`k-1-n`1`})`2`}`1`
%     }`
% \end{lstlisting}
% \caption{Staged implementation of quickselect in \lang, using derivable rules.}
% \vspace{1.3em}
% \label{fig:qs-staged}
% \end{subfigure}
\begin{subfigure}{0.5\textwidth}
\begin{lstlisting} 
1`atsigngrnd{
  datatype list = Empty | Cons of int * list
  fun part (...) = ...
} 

`//1`qsStaged : ^list * $`2`int`1` -> $`2`int`1`
fun qsStaged (`3`grnd{`1`Empty`3`}`1`,_) = next {`2`0`1`}
  | qsStaged (`3`grnd{`1`Cons ht`3`}`1`,next{`2`k`1`}) = 
    let 
      val `3`grnd{`1`(n0,left,right)`3`}`1` = `3`grnd{`1`part ht`3`}`1`
      val next{`2`n`1`} = hold `3`grnd{`1`n0`3`}`1`
    in next{`2`
      case compare k n of
        LT => prev {`1`qsStaged (`3`grnd{`1`left`3`}`1`, next{`2`k`1`})`2`}
      | EQ => prev {`1`hold `3`grnd{`1`#1 ht`3`}`2`}
      | GT => prev {`1`qsStaged (`3`grnd{`1`right`3`}`1`, next{`2`k-1-n`1`})`2`}`1`
    }`
\end{lstlisting}
\caption{Staged implementation of quickselect in \lang.}
%\vspace{1.3em}
\label{fig:qs-staged}
\end{subfigure}
\caption{Quickselect: traditional and staged.}
\end{figure*}

