%!TEX root = ../paper.tex

\begin{figure*}
\begin{subfigure}{0.5\textwidth}
\begin{lstlisting} 
datatype list = Empty | Cons of int * list
fun part (p, Empty) = (0,Empty, Empty) 
  | part (p, Cons (h,t)) = 
    let val (s,left,right) = part (p,t) in 
    if h<p 
    then (s+1,Cons(h,left),right) 
    else (s,left,Cons(h,right))

fun qSelect (l : list, k : int) : int = 
  case l of
    Empty => 0
  | Cons (h,t) => 
      let (left,right,n) = partition h t in
        case compare k n of
          LT => qSelect (left, k)
        | EQ => h
        | GT => qSelect (right, k-1-n)
\end{lstlisting}
\caption{Unstaged implementation of quickselect.}
\label{fig:qs-unstaged}
\end{subfigure}%
\begin{subfigure}{0.5\textwidth}
\begin{lstlisting} 
1`atsignmono{`3`datatype list = Empty | Cons of int * list`1`}
fun partition (mono{`3`p`1`} : ^`3`int`1`, mono{`3`l`1`} : ^`3`list`1`) =
  let atsign mono{`3` 
    fun part (...) = ...
    val (n,left,right) = part (p,l)
  `1`} in
  (mono{`3`n`1`},mono{`3`left`1`},mono{`3`right`1`})

datatype listU = EmptyU | ConsU of ^`3`int`1` * ^`3`list`1`
fun unwrap mono{`3`Empty`1`} = EmptyU
  | unwrap mono{`3`Cons(h,t)`1`} = ConsU(mono{`3`h`1`},mono{`3`t`1`})

fun qsStaged (l : ^`3`list`1`, next{`2`k`1`} : $`2`int`1`) : $`2`int`1` = 
  case unwrap l of
    EmptyU => next {`2`0`1`}
  | ConsU (h,t) => 
    let val (n,left,right) = partition h t
        val next{`2`n`1`} = hold n 
    in next{`2`
      case compare k n of
        LT => prev {`1`qsStaged (left, next{`2`k`1`})`2`}
      | EQ => prev {`1`hold h`2`}
      | GT => prev {`1`qsStaged (right, next{`2`k-1-n`1`})`2`}`1`
    }`



\end{lstlisting}
\caption{Staged implementation of quickselect in \lang.}
\vspace{4.8em}
\label{fig:qs-staged}
\end{subfigure}
\caption{Quickselect: traditional and staged.}
\end{figure*}


