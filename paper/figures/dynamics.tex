%!TEX root = ../paper.tex

\begin{figure}
\begin{abstrsyn}
\[\begin{aligned}
\text{Values}\ \ 
u &::= \tup{}
 \gbar \lam {\var}{e} \\
&\gbar \tup{u, u}
 \gbar \inl u 
 \gbar \inr u \\
\text{Partial Values}\ \ 
v &::= \tup{}
 \gbar \lam {\var}{\expr} \\
&\gbar \tup{v, v}
 \gbar \inl v 
 \gbar \inr v \\
&\gbar \next {\hat y}
 \gbar \pure u \\
\text{Residuals}\ \ 
q &::= \tup{}\gbar\var%\bool
 \gbar \lam {\var}{q} 
 \gbar \app q q \\
&\gbar \tup{q, q} 
 \gbar \pio q 
 \gbar \pit q \\
&\gbar \inl q 
 \gbar \inr q
 \gbar \caseof {q}{\var.q}{\var.q} \\
&\gbar \roll e
 \gbar \unroll e\\
\text{Residual Table}\ \ 
\xi &::= \cdot
 \gbar \xi, {\hat y} \mapsto q \\
\end{aligned}\]
\end{abstrsyn}
\caption{Values, partial values, and residuals are restricted forms of expressions
which appear as part of evaluation.
They are given here as grammars.  
Residual tables, a new construct, are also produced as part of evaluation.}
\label{fig:values}
\end{figure}

\begin{figure*}
\begin{abstrsyn}
\begin{mathpar}
\fbox{1-Evaluation}	\and
\inferdiaone[\rmunit]
{\red {\tup{}}{\cdot;\tup{}}}
{\cdot}
\and
\inferdiaone [\to I]
{\red {\lam{x}{e}} {\cdot;\lam{x}{e}}}
{\cdot}
\and
\inferdiaone [\to E]
{\red {\app {e_1}{e_2}} {\gcomp 1 2, \xi';v'}}
{\red {e_1} {\xi_1;\lam{x}{e'}} & \sub [2] & \red  [\Gamma,\dom{\xi_1},\dom{\xi_2}] {[v_2/x]e'}{\xi';v'}}
\and
%
\inferdiaone [\times I]
{\red {\tup{e_1,e_2}}{\gcomp 1 2;\valprod{v_1}{v_2}}}
{\sub [1] & \sub [2]}
\and
\inferdiaone [\times E_1]
{\red {\pio{e}}{\xi;v_1}}
{\red{e}{\xi;\valprod{v_1}{v_2}}}
\and
\inferdiaone [\times E_2]
{\red {\pit{e}}{\xi;v_2}}
{\red{e}{\xi;\valprod{v_1}{v_2}}}
\and
\inferdiaone [+ I_1]
{\red {\inl{e}} {\xi;\inl{v}}}
{\sub}
\and
\inferdiaone [+ I_2]
{\red {\inr{e}} {\xi;\inr{v}}}
{\sub}
\and
%
\inferdiaone [+ E_1]
{\red {\caseof{e_1}{x_2.e_2}{x_3.e_3}}{\gcomp 1 2;v_2}}
{\red {e_1}{\xi_1;\inl{v}} & \red
  [\Gamma,\dom{\xi_1}]{[v/x_2]e_2}{\xi_2;v_2}}
\and
\inferdiaone [+ E_2]
{\red {\caseof{e_1}{x_2.e_2}{x_3.e_3}}{\gcomp 1 3;v_3}}
{\red {e_1}{\xi_1;\inr{v}} & \red
  [\Gamma,\dom{\xi_1}]{[v/x_3]e_3}{\xi_3;v_3}}
\and
\inferdiaone[\mu I]
{\red {\roll{e}}{\xi;\roll{v}}}
{\sub}
\and
\inferdiaone[\mu E]
{\red {\unroll{e}}{\xi; v}}
{\red {e}{\xi; \roll{v}}}
\end{mathpar}

\hrule
\begin{mathpar}
\fbox{Residualization}
\and
\inferdiaspc[\rmunit]
{\red {\tup{}}{\tup{}}}
{\cdot}
\and
%\inferdiaspc[int]
%{\red {i}{i}}
%{\cdot}
%\and
%% %\inferdiaspc [bool]{\red {b}{b}}
%% {\cdot}
%% \and
\inferdiaspc[hyp]
{\red {x}{x}}
{\cdot}
\and
\inferdiaspc[\to I]
{\red {\lam{x}{e}}{\lam{x}{q}}}
{\diatwo [\Gamma,x] e q} 
\and
\inferdiaspc [\to E]
{\red {\app {e_1} {e_2}}{q_1~q_2}}
{\sub [1] & \sub [2]}
\and
\inferdiaspc [\times I]
{\red {\tup{e_1,e_2}}{\tup{q_1,q_2}}}
{\sub [1] & \sub [2]} 
\and
\inferdiaspc [C]
{\red {\scriptCapp e}{\scriptCapp q}}
{\sub & \scriptC \in \{\mathtt{pi1},\mathtt{pi2},\mathtt{inl},\mathtt{inr},\mathtt{roll},\mathtt{unroll}\}}
%\inferdiaspc[+ I_2]
%{\red {\inr~e}{\inr~q}}
%{\sub}
\and
\inferdiaspc[+ E_1]
{\red {\caseof{e_1}{x_2.e_2}{x_3.e_3}}
{\caseof{q_1}{x_2.q_2}{x_3.q_3}}}
{\sub [1] & \diatwo [\Gamma,x_2] {e_2} {q_2} & \diatwo [\Gamma,x_3] {e_3} {q_3}} 
%\inferdiaspc [\mu E]   		{\red {\unroll~e}{\unroll~v}}
%	{\sub}										\and
%\inferdiaspc [let]			{\red {\letin{x}{e_1}{e_2}}{\letin{x}{q_1}{q_2}}}			{\sub [1] & \diatwo [\Gamma,x] {e_2} {q_2}} 					\and
%\inferdiaspc [if_T] 			{\red {\ifthen{e_1}{e_2}{e_3}}{\ifthen{q_1}{q_2}{q_3}}}	{\sub [1] & \sub [2] & \sub [3]} 		\and
%
\end{mathpar}
\hrule
\begin{mathpar}
\fbox{Staging Features} \and
\inferdiaone [\fut I]	{\red {\next{e}}{\hat y \mapsto q;\next{\hat y}}}			{\diatwo e q}														\and
\inferdiaspc [\fut E]	{\red {\prev{e}} q}											{\diaone e {\xi; \next{\hat y}} & \reify{\xi}{\hat y}q}				\and
%\inferdiaone [hold]		{\red {\pause e} {\xi, \hat y \mapsto i; \next {\hat y}}}	{\red e {\xi; \pure i}}												\and
\infer					{\reify {\cdot}{q}{q}}										{\cdot}																\and
\infer					{\reify {y \mapsto q_1, \xi}{q_2}{\letin{y}{q_1}{q'}}}		{\reify{\xi}{q_2}{q'}}												\and
\inferdiaone			{\red {\pure e} {\cdot; \pure v}}							{\reduce e v} 														\and
\inferdiaone			{\red {\letp x {e_1} {e_2}} {\xi_1, \xi_2; v_2}}			{\red {e_1} {\xi_1;\pure {v_1}} & \red {[v_1/x]e_2} {\xi_2;v_2}} 	\and
%\inferdiaone			{\red {\lifttag e} {\xi;\inl{\pure v}}}						{\red e {\xi; \pure{\inl v}}}										\and
%\inferdiaone			{\red {\lifttag e} {\xi;\inr{\pure v}}}						{\red e {\xi; \pure{\inr v}}}										
\inferdiaone [+ E_1]	{\red {\caseP{e_1}{x_2.e_2}{x_3.e_3}}{\gcomp 1 2;v_2}}		{\red {e_1}{\xi_1;\pure{\inl{v}}} 
																					&\red [\Gamma,\dom{\xi_1}]{[\pure v/x_2]e_2}{\xi_2;v_2}}			\and
\inferdiaone [+ E_2]	{\red {\caseP{e_1}{x_2.e_2}{x_3.e_3}}{\gcomp 1 3;v_3}}		{\red {e_1}{\xi_1;\pure{\inr{v}}}
																					&\red [\Gamma,\dom{\xi_1}]{[\pure v/x_3]e_3}{\xi_3;v_3}}		
\end{mathpar}

\end{abstrsyn}
\caption{\lang~Dynamic Semantics.}
\label{fig:diaSemantics}
\end{figure*}
